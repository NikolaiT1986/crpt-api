# CrptApi

[![](https://jitpack.io/v/NikolaiT1986/crpt-api.svg)](https://jitpack.io/#NikolaiT1986/crpt-api)

Проект представляет собой класс для работы с API Честного знака (ГИС МТ). Класс является thread-safe и реализует
ограничение на количество запросов, используя стратегию лимитирования со скользящим окном.

### Описание

Класс `CrptApi` реализует метод для создания документа для ввода в оборот товара, произведенного в России.
Класс включает:

- Лимитирование запросов (с использованием стратегии скользящего окна).
- JSON-сериализация с использованием Jackson.
- Удобная возможность для тестирования и расширения.

### Требования

- Java 11+
- Maven 3.6+

### Функциональность

1. **Метод для создания документа**: Создание документа типа `LP_INTRODUCE_GOODS`, который используется для ввода в
   оборот товара, произведенного на территории Российской Федерации.
2. **Ограничение на количество запросов**: В конструктор передается время (`TimeUnit`) и количество запросов, которые
   можно выполнить в указанное время.
3. Доступны две реализации лимитера:
    - SlidingWindowRateLimiter — скользящее окно (точный учёт N запросов за заданный интервал);
    - FixedWindowSemaphoreLimiter — фиксированное окно на семафоре (≤ N запросов за окно, окно обновляется лениво при
      вызовах).
4. **Поддержка формата документа**: Стандартный формат `MANUAL`, но легко можно расширить для других типов.
5. **Обработчик ошибок**: Проверка обязательных полей документа и выбрасывание `NullPointerException` (с сообщением) или
   `IllegalArgumentException` в случае ошибок валидации.

### Структура проекта

- `src/main/java/org/nikolait/crptapi/CrptApi.java` — основной класс для работы с API.
- `src/test/java/org/nikolait/crptapi/` — тесты для проверки функционала API.
- `src/test/resources/docs/` — тестовые файлы JSON для создания документов.

### Установка

Библиотека доступна через [JitPack](https://jitpack.io/#NikolaiT1986/crpt-api).

### Пример использования с минимальным набором параметров

```java
import org.nikolait.crptapi.CrptApi;

import java.net.http.HttpResponse;
import java.util.concurrent.TimeUnit;

CrptApi api = new CrptApi(TimeUnit.MINUTES, 5);
LpIntroduceGoodsDocument document = new LpIntroduceGoodsDocument();
// Заполните поля документа
HttpResponse<String> response = api.createLpIntroduceGoods(
        "your_bearer_token",
        "productGroup",
        document,
        "signature_base64"
);
```

### Расширяемость

- Можно внедрять свои `HttpClient` и `RateLimiter` благодаря интерфейсам `HttpClientAdapter` и `RateLimiter`.
- Можно наследоваться от самого CrptApi и переопределять публичные протектед методы поля и методы, настраивая класс как
  конструктор.
- Можно наследоваться от публичных вложенных классов, чтобы расширять или модифицировать.
- Для общего протектед метода `createDocument` можно использовать любые объекты помеченные маркерным интерфейсом.
- Имеется возможность добавления дополнительных полей в модели без наследования благодаря полю `extrra`.

### Механика ограничения запросов

SlidingWindowRateLimiter

- Ограничивает число запросов в скользящем окне, границы окна пересчитываются при каждом запросе.
- Использует ReentrantLock + Condition без фоновых потоков.
- Подходит если нужны точные расчёты за текущий интервал, но реализация более тяжёлая чем FixedWindowSemaphoreLimiter.

FixedWindowSemaphoreLimiter

- Ограничивает число запросов в фиксированном окне, границы обновляются только по истечении текущего окна.
- Использует ReentrantLock + Condition, без фоновых потоков.
- Подходит, если допустимы кратковременные скачки нагрузки при смене окна, зато реализация более лёгкая чем
  SlidingWindowRateLimiter.

Лицензия [MIT](https://opensource.org/licenses/MIT)
